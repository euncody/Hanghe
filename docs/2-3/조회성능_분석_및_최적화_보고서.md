
# 📄 조회 성능 분석 및 최적화 보고서

## 1. 분석 개요
- **대상 시스템**: 전자상거래 시스템 `Hanghe`
- **검토 범위**: Product, Order, User 관련 Repository, JPA Entity, Query, Controller, Index 구조 등
- **분석 목적**: 실제 운영 시 발생 가능한 조회 성능 저하 지점을 사전 식별하고, 그에 대한 **원인 분석** 및 **쿼리/인덱스 최적화**를 제안

---

## 2. 성능 저하 가능 기능 및 원인 분석

| 기능/쿼리 | 성능 저하 원인 | 상세 내용 |
|----------|----------------|-----------|
| 🔍 `OrderJpaRepository.findByOrderItems_ProductCode(String)` | ❌ 잘못된 경로 매핑 <br> ❌ productCode 속성 누락 | `OrderItemEntity`에 `productCode` 필드가 없음 → 경로 탐색 실패로 실행 불가 |
| 🛒 `ProductRepository.findAllOrderByPrice()` | ⚠ 인덱스 부재 가능 | price 정렬 시 인덱스(`idx_price`)는 있으나, 복합 조건 검색 시에는 비효율 발생 가능 |
| 📦 `OrderRepository.findByUserId(String)` | ⚠ 단순 필터링 | Order <-> User 간 조인 시 N+1 쿼리 가능성 존재 |
| 📄 상세 조회 API (예: `/orders/{id}`) | ⚠ DTO 변환 중 과도한 접근 | Entity → DTO 매핑 시 연관 엔티티에 대한 Lazy Loading 발생 가능 |
| 🔍 Controller 테스트에서 `@WebMvcTest` 사용 | ❌ 통합 테스트 목적과 불일치 | 통합 테스트 목적이라면 `@SpringBootTest` + `@AutoConfigureMockMvc` 추천 |

---

## 3. 인덱스 설계 제안

| 테이블 | 컬럼 | 인덱스 제안 | 목적 |
|--------|------|-------------|------|
| `product` | `product_code` | ✅ (이미 존재) | 정확한 조회 시 유용 |
| `product` | `amount` | ✅ 신규 제안: `idx_amount` | 재고 기준 정렬 및 필터링 시 사용 |
| `product` | `product_code, amount` (복합) | ✅ `idx_code_amount` | 다중 조건 복합 조회 성능 향상 |
| `order_item` | `product_code` | ⚠ Entity 상에는 존재 안함 | 도메인 모델 수정 필요 |
| `order` | `user_id` | ✅ 존재해야 함 | 사용자별 주문 내역 조회 최적화 |

---

## 4. 쿼리/코드 재설계 제안

| 문제 | 개선안 |
|------|--------|
| ❌ JPA 메서드 명으로 복잡한 경로 탐색 (`orderItems.productCode`) | ✔ 명시적인 `@Query` 사용 또는 Join Fetch 방식 도입 |
| ⚠ Entity 매핑 중 Lazy 로딩으로 인한 N+1 발생 | ✔ DTO 변환 시 fetch join 또는 `@EntityGraph` 사용 |
| ❌ 테스트에서 mock 사용 중복 | ✔ 통합 테스트는 실제 `MockMvc` + DB를 사용하고, 단위 테스트는 mockk 유지 |
| ❌ Mapper 내 Optional 처리 미흡 | ✔ null safe 코틀린 변환 방식 활용 (`?.let {}` 등) |

---

## 5. 결론 및 제언

- 조회 성능 저하의 근본 원인은 **잘못된 엔티티 매핑**, **경로 탐색 실패**, **인덱스 부족**, **과도한 연관 관계 접근**입니다.
- 아래 작업들을 권장합니다:
  1. `OrderItemEntity`에 `productCode` 매핑 필드 추가
  2. 인덱스 추가: `product(amount)`, `product(product_code, amount)`
  3. JPA 경로 탐색 대신 명시적 JPQL 또는 `@Query` 사용
  4. N+1 회피를 위한 fetch join 또는 `@EntityGraph` 적용
  5. 테스트 클래스 구분 명확화 (`@WebMvcTest` vs `@SpringBootTest`)

---

## 📎 참고 파일 목록

- `OrderEntity.kt`, `OrderItemEntity.kt`, `OrderJpaRepository.kt`, `ProductRepository.kt`
- `OrderMapper.kt`, `UserMapper.kt`
- 테스트: `OrderServiceTest`, `OrderControllerTest`, `UserServiceTest`, 등
