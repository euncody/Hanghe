# 🔒 비관적 락(Pessimistic Lock)이란?

> 다른 트랜잭션이 **같은 데이터를 수정할까 걱정돼서 미리 락을 거는 방식**  
즉, **"혹시 모르니 내가 끝날 때까지 아무도 못 건드리게 막자!"**

---

## 🍱 비유: 복사기 사용

- 복사기 쓰려는데 누가 올까 걱정돼서 **문 잠그고 복사함**.
- 다른 사람은 **기다림**.
- 👉 이게 바로 비관적 락!

---

## 🧩 동작 방식 요약

1. 데이터를 가져올 때 **락 먼저 건다**.
2. 다른 트랜잭션은 **락 풀릴 때까지 대기**.
3. 내 작업 끝나면 **락 해제**.
4. 충돌 없음, 안정성 최고!

---

## 📊 장점 vs 단점

| 장점                         | 단점 |
|------------------------------|------|
| 충돌 절대 없음 (안정성 ↑)   | 성능 저하 가능 (대기 발생) |
| 데이터 꼬임 방지             | 교착 상태 위험 있음 |

---

## 🔧 비관적 락 사용 방법

### SQL 예시

```sql
-- 특정 행에 배타 락 (쓰기 락)
SELECT * FROM products WHERE id = 1 FOR UPDATE;
```

### Kotlin + JPA 예시

```kotlin
import org.springframework.data.jpa.repository.Lock
import org.springframework.data.jpa.repository.Query
import javax.persistence.LockModeType

interface ProductRepository : CrudRepository<Product, Long> {

    @Lock(LockModeType.PESSIMISTIC_WRITE)
    @Query("SELECT p FROM Product p WHERE p.id = :id")
    fun findWithLock(id: Long): Product?
}
```

---

## ⚠️ 주의사항

| 주의할 점           | 설명 |
|---------------------|------|
| 트랜잭션 필수      | 락은 트랜잭션 안에서만 작동 (`@Transactional`) |
| 타임아웃 설정 가능 | 너무 오래 기다리면 자동 실패 처리 필요 |
| 교착 상태 주의     | 락 순서 잘못되면 무한 대기 가능 |

---

## 💡 정리 

1. 비관적 락은 **먼저 락 걸고 충돌을 원천 차단**하는 방식.
2. 안정성은 높지만 **성능 저하 위험 있음**.
3. 락은 **트랜잭션 안에서만 작동**, 타임아웃 설정 권장.
